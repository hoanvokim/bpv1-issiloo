/*!
 * flxMenu v1.0
 * https://github.com/LTS-Tools/flxMenu
 *
 * Copyright (c) 2018 Alfred Lorenz.  All rights reserved.
 * Released under the MIT license.
 *
 * Date: Thu Jul 12 2018
 */
(function(a){if(a.fn.flxMenu){return}a.fn.flxMenu=function(h,i){var c={puTop:0,puLeft:1,puRight:2};var q={fnChanged:function(G,H,F){t(true,"Moved bar from {1} to {0}",H[0].id,F[0].id)},fnInit:function(F,G){},fnSubmenuClosing:function(F){t(true,'closing submenu of <{0} id="{1}">',F[0].nodeName,F.attr("id"))},fnPopupShowing:function(F){t(true,"Popup showing {0} ",F)},duration:300,orientation:"horizontal",smShowByClick:false,puSlideInFrom:"top",puCloseOnSelect:false,puShowActiveItem:false,puAligned:false,puFullRange:true,smFilterClass:false,framework:false,debug:false};if(!a.fn.flxLog){if(i.debug){console.log('flxMenu: !!! load "debug.js" for logging outputs !!!')}a.fn.flxLog=function(){}}function g(F,G){t(true,"DoNothing called on "+G.attr("id"))}function y(F,G){$li=a(F.target).closest("li");if($li.is(G)){u(G,1)}F.stopPropagation()}function B(F,G){F.preventDefault();u(G)}function m(F,G){F.preventDefault();r(G)}if(this.length==0){t(true,'No element found for "'+this.selector+'".');return this}if(this.length>1){t(true,'Found more than one element for "'+this.selector+'".');t(true,'Only handle the first: "'+this[0].id+'".');a(this[0]).flxMenu(h,i);return this}if(this.data("flxMenu")){t(true,"flxMenu has already been applied");return}var k=this;this.data("flxMenu",true);var i=a.extend({},q,i||{});k.addClass("flxMenu");function t(F,I,O,N,M,L,K,J,H,G){if(F){a.fn.flxLog(I,O,N,M,L,K,J,H,G)}}function v(F){$root=F.closest(".flxMenu");return $root[0].flxOptions}function z(F){$frame=F.children("ul, div").first().css({overflow:"hidden",height:0});F.removeClass("displaySubmenu")}function r(I,F){var H=v(I);if(H.framework=="lyraT4"){if(window.editPermissions){ltxCancelForm()}}H.fnSubmenuClosing(I);I.removeClass("inProgrOpen");var G=I.children("ul, div").first();G.stop(true,false);if(F){I.children("ul, div").first().css("overflow","hidden").animate({height:0},H.duration);I.removeClass("displaySubmenu");I.find(".displaySubmenu").each(function(){var J=a(this);J.children("ul, div").first().css("overflow","hidden").animate({height:0},H.duration);J.removeClass("displaySubmenu")})}else{z(I);I.find(".displaySubmenu").each(function(){z(a(this))})}a(document).off("click.flxMenu")}function u(M,G){if(!M.hasClass("hasSubmenu")){return false}if(M.hasClass("displaySubmenu")&&(G==1)){r(M,true);return false}if(M.hasClass("inProgrOpen")||M.hasClass("displaySubmenu")){return true}var J=v(M);M.siblings("li.displaySubmenu").each(function(){r(a(this),G)});if(J.smShowByClick&&!J.popup){a(document).on("click.flxMenu",function(O){var N=a(O.target).closest(".flxInitFrame");if(N.length){console.log("clicked on item of mainMenu")}else{r(M,true)}})}var L=M.children("ul, div");var H=a(L[0]);var F=H.width();H.css("position","fixed");H.css("left",-9999);H.css("width",F);H.css("height","auto");subH=H.outerHeight()+3;t(J.debug,"__flxOpenSubmenu - sub frame calculated h: {0}",subH);H.css("position","");H.css("left","");H.css("height",0);H.css("width","");var K=M.parent().closest(".displaySubmenu").children("ul, div");if(K.length>0){var I=a(K[0]);t(J.debug,"__flxOpenSubmenu - parent sub frame: <{0}>",K[0].nodeName);I.css("height","auto");I.css("overflow","visible")}M.addClass("inProgrOpen");H.animate({height:subH+"px"},J.duration,function(){M.removeClass("inProgrOpen")});M.addClass("displaySubmenu");return H}function n(G,L,K,F,I){var J=v(G);t(J.debug,"flxMenuCheckPosition({0}, {1}, {2})",G[0].id,L[0].id,K[0].id);t(J.debug,"- flxOptions.popup: {0}",J.popup);var H=false;if(F.css("display")!="none"){H=true}$Li=G.find("li");$Li.each(function(){if(a(this).hasClass("displaySubmenu")){z(a(this))}});if(H){if((!J.popup)||I){G[0].onItemEnter=g;G[0].onItemLeave=g;G[0].onItemClick=y;F.show();K.append(G);J.popup=true;if(J.framework=="lyraT4"){if(window.editPermissions){F.find(".ltxContainer").addClass("ltx-locked");if(!I){ltxCancelForm()}}}J.fnChanged(true,F,L)}}else{F.removeClass("showUp");F.children(".menuFrame").hide();if(J.popup||I){if(J.smShowByClick){G[0].onItemEnter=g;G[0].onItemLeave=g;G[0].onItemClick=y}else{G[0].onItemEnter=B;G[0].onItemLeave=m;G[0].onItemClick=g}L.prepend(G);J.popup=false;if(J.framework=="lyraT4"){if(window.editPermissions){F.find(".ltxContainer").removeClass("ltx-locked")}}J.fnChanged(false,L,F)}L.show();$Li.first().find("a:first").focus()}}function j(I,L,H,G){t(H.debug,"__flxFindTargetInFrame(<{0}>, {1}, {2})",I[0].nodeName,L,G);var K=I.parent();if(K.is("li")){if(G){return[]}return K}var J=1;if(G){J=-1}$pFrameChildren=K.children().filter(function(){if(this==I[0]){t(H.debug,"remove element <{0}> from frame set",this.nodeName);return false}var N=a(this).offset().left;var M=L.left-N;if(M*J<5){t(H.debug,"remove element <{0}> from frame set; left: {1} ",this.nodeName,N);return false}return true});if($pFrameChildren.length>0){var F=9999;$target=[];$pFrameChildren.find("li").each(function(){var O=a(this).offset();t(H.debug,"compare <li> {0} with {1}",O,L);var N=(L.left-O.left)*J;if(N>5){var M=Math.abs(L.top-O.top);if(M<F){t(H.debug,"setting bestDY {0} to {1}",F,M);F=M;$target=a(this)}}});return $target}else{return j(K,L,H,G)}}function l(H,M,G,L){t(G.debug,"__flxFindTargetInFrameV(<{0}>, {1})",H[0].nodeName,L);var J=H.parent();if(J.is("li")){if(G.popup){if(L){return J}return J.next()}if(L){r(M);return J}return[]}var I=1;if(L){I=-1}var K=M.offset();$pFrameChildren=J.children().filter(function(){if(this==H[0]){t(G.debug,"remove element <{0}> from frame set",this.nodeName);return false}var O=a(this).offset().top;var N=O-K.top;if(N*I<20){t(G.debug,"remove element <{0}> from frame set; top: {1} ",this.nodeName,O);return false}return true});if($pFrameChildren.length>0){var F=9999;$target=[];$pFrameChildren.find("li").each(function(){var P=a(this).offset();t(G.debug,"compare <li> {0} with {1}",P,K);var O=(P.top-K.top)*I;if(O>5){var N=Math.abs(K.top-P.top);if(N<F){t(G.debug,"setting bestDY {0} to {1}",F,N);F=N;$target=a(this)}}});return $target}return l(J,M,G,L)}function d(L,H){var K=L.children(".menuFrame");var I=K.children(".menuSlider");var G=I.children(".flxMenu");var J=G[0].flxOptions;t(J.debug,'"menuShow" triggered');var F;$Li=G.find("li");$Li.each(function(){if(a(this).hasClass("active")){F=a(this).children("a");if(!F.prop("href")){F.prop("href","javascript:")}a(this).parentsUntil(".flxMenu","li").each(function(M){$parentLi=a(this);$parentLi.addClass("displaySubmenu");$parentLi.children("ul, div").first().css("height","auto")})}else{z(a(this))}});if(H){C(K,I,J,H)}else{x(K,I,J)}K.parent().addClass("showUp");if(!F){F=$Li.first().find("a:first")}t(J.debug,"try to set focus to {0}",F.text());F.focus();J.fnPopupShowing(true,L)}function C(L,J,K,H){var I="left";var F="right";if(H==c.puRight){I="right";F="left"}L.css("display","block");if(K.puAligned){L.css(I,"100%")}else{L.css(I,0)}L.css(F,"auto");L.css("width",0);L.css("overflow","hidden");J.css("position","fixed");J.css(F,"auto");J.css(I,-9999);var G=J.outerWidth()+3;if(K.puFullRange){L.css("position","fixed");L.css("height","100%");J.css("height","100%")}else{L.css("height",J.outerHeight())}t(K.debug,"flxPopupMoveInHoriz - menu w: {0}",G);J.css("position","");J.css(I,0);J.css(F,"auto");J.addClass("inProgrOpen");L.animate({width:G},K.duration,function(){J.removeClass("inProgrOpen");L.parent().addClass("showUp");L.css("overflow","")})}function x(H,F,G){H.css("display","block");if(G.puAligned){H.css("top","100%")}else{H.css("top",0)}H.css("height",0);H.css("overflow","hidden");F.css("position","fixed");F.css("bottom","auto");F.css("top",-9999);var I=F.outerHeight();t(G.debug,"flxPopupMoveInTop - menu calculated h: {0}",I);F.css("position","");F.css("bottom",0);F.css("top","auto");if(G.puFullRange){if(!G.puAligned){H.css("position","fixed")}H.css("left","0");H.css("width","100%");F.css("width","100%")}else{H.css("width",F.outerWidth())}F.addClass("inProgrOpen");H.animate({height:I},G.duration,function(){F.removeClass("inProgrOpen");H.parent().addClass("showUp");H.css("overflow","");F.css("bottom","auto");F.css("top",0)})}function A(K,G){var J=K.children(".menuFrame");var H=J.children(".menuSlider");var F=H.children(".flxMenu");var I=F[0].flxOptions;t(I.debug,'"menuClose" triggered');J.css("overflow","hidden");if(G){E(J,H,I)}else{D(J,H,I)}K.removeClass("showUp");K.children("a").first().focus();I.fnPopupShowing(false,K)}function D(H,F,G){H.animate({height:0},G.duration,function(){H.parent().removeClass("showUp");H.css("display","none")})}function E(I,G,H){var F=G.outerWidth()+3;t(H.debug,"flxPopupMoveOutLeft - menu w: {0}",F);I.css("height",G.outerHeight());I.animate({width:0},H.duration,function(){I.parent().removeClass("showUp");I.css("display","none")})}function f(F){d(a(this))}function p(F){d(a(this),c.puLeft)}function e(F){d(a(this),c.puRight)}function s(F){A(a(this),c.puLeft)}function b(F){A(a(this),c.puRight)}function o(F){A(a(this))}function w(F,O){t(i.debug,"init with options: {0}",i);F.target=O[0];if(i.puSlideInFrom!="top"){i.puAligned=false}var N=O.children("a").first();if(N.length>0){if(N.hasClass("flxMenuToggle")){N.click(function(){a(this).trigger("menuToggle")});i.puAligned=true}else{N.addClass("flxMenuOpen");N.click(function(){a(this).trigger("menuShow")})}}else{var I="";if(i.img){I='<img class="menuSymbol" src="'+i.img+'" />'}else{I='<ul class="menuSymbol"><li></li><li></li><li></li></ul>'}if(i.puAligned){var K='<a href="javascript:" class="flxMenuToggle">'+I+"</a>";N=a(K);N.click(function(){a(this).trigger("menuToggle")})}else{var K='<a href="javascript:" class="flxMenuOpen">'+I+"</a>";N=a(K);N.click(function(){a(this).trigger("menuShow")})}O.prepend(N)}var G=O.children(".menuFrame");if(G.length==0){var L="";if(!N.hasClass("flxMenuToggle")){L='<a href="javascript:" title="close" class="menuClose" onclick="$(this).trigger(\'menuClose\')"> </a>'}var M='<div class="menuFrame"><div class="menuSlider">'+L+"</div></div>";O.append(a(M))}if(!F.id){F.id="flxMenu"}var J=a(F);$menuButtons=J.find("a");$menuButtons.on("keydown",function(P){var T=v(a(this));t(T.debug,"keydown code {1} on {0}",a(this).text(),P.which);switch(P.which){case 27:P.preventDefault();a(this).trigger("menuClose");break;case 13:$Li=a(this).closest("li");if($Li.hasClass("hasSubmenu")){P.preventDefault();u($Li)}break;case 40:P.preventDefault();$Li=a(this).closest("li");var S=[];var R=$Li.css("float");if((R=="left")||(R=="right")){if($Li.hasClass("hasSubmenu")){u($Li);S=$Li.find("li:first")}}else{S=$Li.next();if(S.length==0){S=l($Li.parent(),$Li,T);if(S.length==0){break}R=S.css("float");if((R=="left")||(R=="right")){break}}else{if(!T.popup){r($Li)}}}if(S.length>0){S.find("a:first").focus()}break;case 38:P.preventDefault();$Li=a(this).closest("li");var R=$Li.css("float");if((R=="left")||(R=="right")){if($Li.hasClass("displaySubmenu")){r($Li)}break}var S=$Li.prev();if(S.length==0){S=l($Li.parent(),$Li,T,true)}else{if(!T.popup){r($Li)}}if(S.length>0){S.find("a:first").focus()}break;case 37:P.preventDefault();$Li=a(this).closest("li");if($Li.hasClass("displaySubmenu")){r($Li);break}var S=[];var R=$Li.css("float");if(R=="left"){S=$Li.prev()}else{if(R=="right"){S=$Li.next()}else{var Q=$Li.parent();S=j(Q,$Li.offset(),T);if(S.length==0){S=Q.closest("li")}}}if(S.length>0){S.find("a:first").focus()}break;case 39:P.preventDefault();$Li=a(this).closest("li");var S=[];var R=$Li.css("float");if(R=="left"){if(!T.popup){r($Li)}S=$Li.next()}else{if(R=="right"){if(!T.popup){r($Li)}S=$Li.prev()}else{if($Li.hasClass("hasSubmenu")){u($Li,39);S=$Li.find("li:first")}else{S=j($Li.parent(),$Li.offset(),T,true)}}}if(S.length>0){S.find("a:first").focus()}break}});if(i.framework=="lyraT4"){if(window.editPermissions){t(i.debug,'setting "smShowByClick" in lyraT4 edit mode');i.smShowByClick=true}}if(i.puCloseOnSelect){$menuButtons.on("click",function(){if(!a(this).closest("li").hasClass("hasSubmenu")){a(this).trigger("menuClose")}})}var H=i.initialFrame;if(!H||H.length==0){t(i.debug,'build elemFrame around "{0}"',F.id);J.wrap('<div id="flxFrame'+F.id+'"></div>');H=a(F).parent()}F.initialFrame=H[0];H.addClass("flxInitFrame");if(i.orientation=="vertical"){H.addClass("flx-vertical")}J.find("li").each(function(){var P=a(this);if(P.find("li").length>0){P.addClass("hasSubmenu");P.on("click",function(Q){J[0].onItemClick(Q,P)});P.on("mouseenter",function(Q){J[0].onItemEnter(Q,P)});P.on("mouseleave",function(Q){J[0].onItemLeave(Q,P)})}});O.addClass("menuTrigger");if(i.puSlideInFrom=="left"){O.on("menuClose",s).on("menuShow",p);O.addClass("flx-left")}else{if(i.puSlideInFrom=="right"){O.on("menuClose",b).on("menuShow",e);O.addClass("flx-right")}else{O.on("menuClose",o).on("menuShow",f)}}O.on("menuToggle",function(){if(a(this).hasClass("showUp")){a(this).triggerHandler("menuClose")}else{a(this).triggerHandler("menuShow")}});J.on("flxMenuCheck",function(){var P=a(this.target);n(J,a(this.initialFrame),P.children(".menuFrame").children(".menuSlider"),P)}).on("flxMenuNewItem",function(Q,P){a(P).parentsUtil(".flxMenu").filter("li").addClass("hasSubmenu")}).on("flxMenuOptions",function(P,R){this.flxOptions=a.extend({},this.flxOptions,R);var Q=v(a(this));t(true,'flxMenuOptions changed options: "{0}"',Q)});a(window).on("resize",function(){a(F).trigger("flxMenuCheck")});F.flxOptions=i;n(J,H,O.children(".menuFrame").children(".menuSlider"),O,true);i.fnInit(J,H,O)}w(this[0],h);return this}}(jQuery));